<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Latest Run Summary</title>
  <link rel="stylesheet" href="./css/styles.css">
  <!-- Auth script - carrega primeiro para bloquear conteúdo -->
  <script src="./js/auth.js"></script>
</head>
<body>
  <script src="./js/load_nav.js"></script>

  <main class="container">
    <header class="header">
      <h1>Latest Run Summary</h1>
      <div class="controls">
        <button id="refreshBtn">Refresh now</button>
        <a id="downloadJson" href="data/latest_run_summary.json" download>Download JSON</a>
      </div>
    </header>

    <!-- Meta info -->
    <section id="meta" class="card">
      <div class="meta-row"><small class="meta-footnote">Run ID: <span id="runId">—</span></small></div>
      <div class="meta-row"><small class="meta-footnote">Last updated: <span id="lastUpdated">—</span></small></div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SEÇÃO 1: KPIs PRINCIPAIS - Métricas-chave de performance
         ═══════════════════════════════════════════════════════════════════════ -->
    <section id="kpis" class="card kpi-grid">
      <div class="kpi" id="kpi-sharpe">
        <div class="kpi-val">—</div>
        <div class="kpi-label">Sharpe</div>
        <div class="kpi-qual-bar"><div class="kpi-qual-fill" id="sharpe-qual-bar"></div></div>
        <div class="kpi-qual-label" id="sharpe-qual-label"></div>
      </div>
      <div class="kpi" id="kpi-return"><div class="kpi-val">—</div><div class="kpi-label">Hist. Ann. Return</div></div>
      <div class="kpi" id="kpi-vol"><div class="kpi-val" id="kpi-vol-val">—</div><div class="kpi-label">Volatilidade</div></div>
      <div class="kpi" id="kpi-hhi">
        <div class="kpi-val" id="kpi-hhi-val">—</div>
        <div class="kpi-label">HHI</div>
        <div class="kpi-qual-bar"><div class="kpi-qual-fill" id="hhi-qual-bar"></div></div>
        <div class="kpi-qual-label" id="hhi-qual-label"></div>
      </div>
      <div class="kpi" id="kpi-top5">
        <div class="kpi-val">—</div>
        <div class="kpi-label">Top 5 %</div>
        <div class="kpi-qual-bar"><div class="kpi-qual-fill" id="top5-qual-bar"></div></div>
        <div class="kpi-qual-label" id="top5-qual-label"></div>
      </div>
      <div class="kpi" id="kpi-turnover"><div class="kpi-val" id="kpi-turnover-val">—</div><div class="kpi-label">Turnover</div></div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SEÇÃO 2: PORTFOLIO ATUAL - Composição e detalhes
         ═══════════════════════════════════════════════════════════════════════ -->
    <section id="portfolio" class="card">
      <h2>Portfolio Recomendado</h2>

      <!-- Tabela de ações -->
      <table id="stocksTable">
        <thead>
          <tr><th>#</th><th>Stock</th><th>Fwd P/E</th><th>Latest Price</th><th>Target Price</th><th>Weight</th><th>Spark</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="tableFootnote" class="table-footnote">
        <small>Data from last run: <span id="tableRunDate">—</span></small>
      </div>

      <!-- Sector Exposure with Forward P/E -->
      <div class="subsection">
        <h3>Exposição por Setor e Forward P/E</h3>
        <div class="chart-card" style="min-height:280px;">
          <canvas id="sectorExposureChart" width="600" height="280" style="width:100%;height:280px;display:block;"></canvas>
        </div>
        <div id="treemap" class="treemap" style="display:none;"></div>
      </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SEÇÃO 3: EVOLUÇÃO HISTÓRICA - Gráficos temporais
         ═══════════════════════════════════════════════════════════════════════ -->
    <section id="historico" class="card">
      <h2>Evolução Histórica</h2>

      <!-- Retorno anual por simulação -->
      <div class="subsection">
        <div class="subsection-header">
          <h3>Retorno Anual por Simulação</h3>
          <div class="range-buttons">
            <button class="range-btn active" data-range="all">All</button>
            <button class="range-btn" data-range="12m">12M</button>
            <button class="range-btn" data-range="6m">6M</button>
            <button class="range-btn" data-range="3m">3M</button>
            <button class="range-btn" data-range="1m">1M</button>
          </div>
        </div>
        <div class="chart-card">
          <canvas id="portfolioChart" width="600" height="260" style="width:100%;height:260px;display:block;"></canvas>
        </div>
        <!-- Stock count range chart (candlestick-style) -->
        <div class="chart-card" style="margin-top:8px;">
          <canvas id="stockRangeChart" width="600" height="120" style="width:100%;height:120px;display:block;"></canvas>
        </div>
        <div class="chart-legend" style="display:flex;gap:16px;justify-content:center;margin-top:8px;font-size:12px;color:#aaa;">
          <span><span style="display:inline-block;width:12px;height:12px;background:rgba(107,156,232,0.3);border:1px solid #6b9ce8;margin-right:4px;"></span>Range (min-max)</span>
          <span><span style="display:inline-block;width:8px;height:8px;background:#f28c28;border-radius:50%;margin-right:4px;"></span>Qtd. Ações Resultante</span>
        </div>
      </div>

      <!-- Evolução da composição -->
      <div class="subsection">
        <div class="subsection-header">
          <h3>Evolução da Composição</h3>
          <small style="color:var(--muted);">clique em um ponto para ver detalhes</small>
        </div>
        <div class="chart-card" style="min-height:280px;">
          <canvas id="compositionHistoryChart" width="600" height="280" style="width:100%;height:280px;display:block;"></canvas>
        </div>
        <div id="compositionLegend" class="composition-legend"></div>
      </div>

      <!-- Histórico de Sharpe e Volatilidade -->
      <div class="history-grid">
        <div class="subsection">
          <div class="subsection-header">
            <h3>Histórico de Sharpe</h3>
            <div class="kpi-mini-inline" id="kpi-sharpe-diag"><span class="kpi-val">—</span></div>
          </div>
          <div class="chart-card" style="height:140px;">
            <canvas id="gaChart" width="600" height="140" style="width:100%;height:140px;display:block;"></canvas>
          </div>
        </div>
        <div class="subsection">
          <div class="subsection-header">
            <h3>Histórico de Volatilidade</h3>
            <div class="kpi-mini-inline" id="kpi-vol-diag"><span class="kpi-val">—</span></div>
          </div>
          <div class="chart-card" style="height:140px;">
            <canvas id="volChart" width="600" height="140" style="width:100%;height:140px;display:block;"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SEÇÃO 4: ANÁLISE DE RISCO - Correlação, concentração, liquidez
         ═══════════════════════════════════════════════════════════════════════ -->
    <section id="risco" class="card">
      <h2>Análise de Risco</h2>

      <!-- Métricas de risco em grid -->
      <div class="risk-metrics-grid">
        <div class="metric-card">
          <div class="metric-card-header">
            <span class="metric-card-title">Tracking Error</span>
            <span class="metric-card-value" id="diag_tracking_error">—</span>
          </div>
          <div class="metric-card-bar">
            <div class="metric-bar-fill tracking-error-bar" id="diag_tracking_bar"></div>
          </div>
          <div class="metric-card-desc">Desvio em relação ao benchmark</div>
        </div>
        <div class="metric-card">
          <div class="metric-card-header">
            <span class="metric-card-title">Information Ratio</span>
            <span class="metric-card-value" id="diag_info_ratio">—</span>
          </div>
          <div class="metric-card-bar">
            <div class="metric-bar-fill info-ratio-bar" id="diag_info_ratio_bar"></div>
          </div>
          <div class="metric-card-qual" id="diag_info_ratio_qual"></div>
          <div class="metric-card-desc">Retorno ativo / Tracking Error</div>
        </div>
        <div class="metric-card">
          <div class="metric-card-header">
            <span class="metric-card-title">Liquidity Score</span>
            <span class="metric-card-value" id="diag_liquidity">—</span>
          </div>
          <div class="metric-card-desc">Volume médio negociado</div>
        </div>
      </div>

      <!-- Matriz de correlação -->
      <div class="subsection">
        <h3>Matriz de Correlação</h3>
        <div class="correlation-legend-scale">
          <span class="scale-label">-1 (inversa)</span>
          <div class="scale-gradient"></div>
          <span class="scale-label">+1 (direta)</span>
          <span class="scale-hint">| <span style="color:var(--accent);">■</span> = no portfolio atual</span>
        </div>
        <div id="correlationMatrix" class="correlation-heatmap"></div>
      </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SEÇÃO 5: VALUATION & MOMENTUM - Métricas de valoração
         ═══════════════════════════════════════════════════════════════════════ -->
    <section id="valuation" class="card">
      <h2>Valuation & Momentum</h2>

      <!-- Métricas de valuation em grid -->
      <div class="valuation-metrics-grid">
        <!-- Momentum Signal com gauge -->
        <div class="metric-card metric-gauge-card">
          <div class="metric-card-header">
            <span class="metric-card-title">Momentum Signal</span>
            <span class="metric-card-value" id="diag_momentum_signal">—</span>
          </div>
          <div class="metric-gauge-container">
            <div class="metric-gauge-bg">
              <div class="metric-gauge-fill" id="diag_momentum_bar"></div>
              <div class="metric-gauge-marker" id="diag_momentum_marker"></div>
            </div>
            <div class="metric-gauge-labels">
              <span>-1</span>
              <span>0</span>
              <span>+1</span>
            </div>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-card-header">
            <span class="metric-card-title">Portfolio P/E</span>
            <span class="metric-card-value" id="diag_portfolio_pe">—</span>
          </div>
          <div class="metric-card-desc">P/E ponderado do portfolio</div>
        </div>
        <div class="metric-card">
          <div class="metric-card-header">
            <span class="metric-card-title">Benchmark P/E</span>
            <span class="metric-card-value" id="bpe">—</span>
          </div>
          <div class="metric-card-desc">P/E médio do benchmark</div>
        </div>
        <!-- Comparação visual P/E -->
        <div class="metric-card metric-compare-card">
          <div class="metric-card-header">
            <span class="metric-card-title">P/E: Portfolio vs Benchmark</span>
            <span class="metric-card-value" id="pe-compare-label">—</span>
          </div>
          <div class="pe-compare-container">
            <div class="pe-compare-bar">
              <div class="pe-compare-portfolio" id="pe-compare-portfolio-bar"></div>
              <div class="pe-compare-benchmark" id="pe-compare-benchmark-bar"></div>
            </div>
            <div class="pe-compare-legend">
              <span><span class="pe-legend-port"></span> Portfolio</span>
              <span><span class="pe-legend-bench"></span> Benchmark</span>
            </div>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-card-header">
            <span class="metric-card-title">Fwd P/E Implied Upside</span>
            <span class="metric-card-value" id="diag_pe_upside">—</span>
          </div>
          <div class="metric-card-desc">Potencial de valorização implícito</div>
        </div>
        <div class="metric-card">
          <div class="metric-card-header">
            <span class="metric-card-title">Dividend Yield (pond.)</span>
            <span class="metric-card-value" id="diag_div_yield">—</span>
          </div>
          <div class="metric-card-desc">Rendimento de dividendos</div>
        </div>
        <div class="metric-card">
          <div class="metric-card-header">
            <span class="metric-card-title">Momentum</span>
            <span class="metric-card-value" id="momentum">—</span>
          </div>
          <div class="metric-card-desc">Momentum do portfolio</div>
        </div>
      </div>
    </section>

    <!-- ═══════════════════════════════════════════════════════════════════════
         SEÇÃO 6: PERFORMANCE ATTRIBUTION - Análise de atribuição
         ═══════════════════════════════════════════════════════════════════════ -->
    <section id="performanceAttribution" class="card">
      <h2>Performance Attribution</h2>
      <div class="attribution-container">
        <div class="attribution-total">
          <div class="attribution-total-label">Total Active Return</div>
          <div class="attribution-total-value" id="attrTotalReturn">—</div>
        </div>
        <div class="attribution-breakdown">
          <div class="attribution-chart-container">
            <canvas id="attributionChart" width="400" height="180" style="width:100%;height:180px;display:block;"></canvas>
          </div>
          <div class="attribution-details" id="attributionDetails">
            <!-- Filled dynamically -->
          </div>
        </div>
      </div>
    </section>

    <footer class="footer">
      <small>Auto-refresh every <span id="interval">10</span>s. Last fetch: <span id="lastFetch">—</span></small>
    </footer>

    <!-- Modal for portfolio composition -->
    <div id="compositionModal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Portfolio Composition</h3>
          <button class="modal-close" id="closeModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="modal-meta">
            <div><strong>Run ID:</strong> <span id="modalRunId">—</span></div>
            <div><strong>Date:</strong> <span id="modalDate">—</span></div>
            <div><strong>Annual Return:</strong> <span id="modalReturn">—</span></div>
            <div><strong>Sharpe Ratio:</strong> <span id="modalSharpe">—</span></div>
          </div>
          <div class="modal-chart-container">
            <canvas id="compositionChart" width="400" height="200"></canvas>
          </div>
          <div id="compositionList" class="composition-list"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Chart.js from CDN (render-only) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Load local app JS with cache-busting so browsers always fetch the updated file during development.
    (function(){
      var s = document.createElement('script');
      s.src = './js/latest_run_summary.js?_=' + Date.now();
      s.defer = true;
      document.body.appendChild(s);
    })();
  </script>
 </body>
 </html>
