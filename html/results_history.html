<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engine Run History</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        nav { margin-bottom: 20px; }
        nav a { margin-right: 15px; text-decoration: none; color: #007bff; }
        nav a:hover { text-decoration: underline; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .chart-container {
            width: 80%;
            max-width: 900px;
            margin: 30px auto;
        }
    </style>
</head>
<body>
    <h1>Engine Run History</h1>
    <nav>
        <a href="progress.html">View Live Progress</a>
    </nav>

    <div class="chart-container">
        <h2>Sharpe Ratio Over Time</h2>
        <canvas id="sharpeRatioChart"></canvas>
    </div>

    <h2>Logged Portfolio Results</h2>
    <table id="resultsTable">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Min Stocks</th>
                <th>Max Stocks</th>
                <th>Data Start</th>
                <th>Data End</th>
                <th>Stock Pool</th>
                <th>Optimal Stocks</th>
                <th>Optimal Weights</th>
                <th>Sharpe Ratio</th>
                <th>Exp. Return (%)</th>
                <th>Exp. Volatility (%)</th>
                <th>Final Value</th>
                <th>ROI (%)</th>
                <th>Initial Investment</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data will be populated here by JavaScript -->
        </tbody>
    </table>

    <script>
        const CSV_PATH = 'data/engine_results_log.csv'; // Adjust if your CSV is elsewhere

        async function fetchAndDisplayResults() {
            try {
                const response = await fetch(CSV_PATH + '?t=' + new Date().getTime()); // Cache buster
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} while fetching ${CSV_PATH}`);
                }
                const csvText = await response.text();
                const rows = csvText.trim().split('\n');
                const headers = rows[0].split(',');
                const data = rows.slice(1).map(rowString => {
                    const values = rowString.split(',');
                    let rowObject = {};
                    headers.forEach((header, index) => {
                        rowObject[header.trim()] = values[index] ? values[index].trim() : 'N/A';
                    });
                    return rowObject;
                });

                populateTable(data, headers);
                renderChart(data);

            } catch (error) {
                console.error('Error fetching or parsing CSV:', error);
                const tableBody = document.getElementById('resultsTable').getElementsByTagName('tbody')[0];
                tableBody.innerHTML = `<tr><td colspan="${headers ? headers.length : 15}" style="text-align:center; color:red;">Error loading data: ${error.message}. Ensure '${CSV_PATH}' is accessible.</td></tr>`;
            }
        }

        function populateTable(data, headers) {
            const tableBody = document.getElementById('resultsTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ''; // Clear existing rows

            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${headers.length}" style="text-align:center;">No data found in CSV.</td></tr>`;
                return;
            }

            data.forEach(rowData => {
                const tr = tableBody.insertRow();
                headers.forEach(header => {
                    const td = tr.insertCell();
                    td.textContent = rowData[header.trim()] || 'N/A';
                });
            });
        }

        function renderChart(data) {
            if (data.length === 0) return;

            const timestamps = data.map(row => row.generation_timestamp);
            const sharpeRatios = data.map(row => parseFloat(row.sharpe_ratio));

            const ctx = document.getElementById('sharpeRatioChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Sharpe Ratio',
                        data: sharpeRatios,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: 'Generation Timestamp' } },
                        y: { title: { display: true, text: 'Sharpe Ratio' } }
                    },
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
        }

        fetchAndDisplayResults();
    </script>
</body>
</html>