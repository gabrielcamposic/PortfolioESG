<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESG Portfolio & Analysis</title>
    <link rel="stylesheet" href="css/navbar_styles.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/stock_colors.css">
    <style>
        body { margin: 0; }
        /* Info icon and hover text styles for metrics table */
        .info-wrapper { display: inline-block; position: relative; }
        .info-icon { display: inline-block; margin-left: 6px; color: #888; cursor: pointer; font-size: 1em; }
        .info-text {
            display: none;
            position: absolute;
            left: 22px;
            top: 50%;
            transform: translateY(-50%);
            background: #f7fafd;
            color: #23272f;
            border: 1px solid #e3e8ee;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.95em;
            white-space: pre-line;
            z-index: 10;
            min-width: 180px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        .info-wrapper:hover .info-text, .info-wrapper:focus-within .info-text { display: block; }
    </style>
</head>
<body>
    <div class="main-content">
        <!-- Top performance metrics -->
        <section class="stage-block">
            <h2 class="accent">Performance Summary</h2>
            <div class="stage-columns">
                <div class="table-container column" style="min-width:260px;">
                    <table class="compact-table metrics-table">
                        <tbody>
                            <tr><td>Final Value</td><td style="text-align:right;" id="perf_final_value">Loading...</td></tr>
                            <tr><td>Daily Return (%)</td><td style="text-align:right;" id="perf_daily_return">Loading...</td></tr>
                            <tr><td>CAGR (%)</td><td style="text-align:right;" id="perf_cagr">Loading...</td></tr>
                            <tr><td>Alpha (Jensen’s Alpha)</td><td style="text-align:right;" id="perf_alpha">Loading...</td></tr>
                            <tr><td>Annual Risk-Free Rate (%)</td><td style="text-align:right;" id="perf_rf_rate">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Metrics columns (left) + composition / charts (right) -->
                <div class="metrics-wrapper column" style="display:flex;gap:20px;align-items:flex-start;flex:1;">
                    <div class="metrics-column" style="flex:1;min-width:220px;">
                        <h3 class="subtle">Risk Metrics</h3>
                        <table class="compact-table metrics-table">
                            <tbody>
                                <tr><td>Daily Volatility (%)</td><td style="text-align:right;" id="risk_daily_vol">Loading...</td></tr>
                                <tr><td>Annualized Volatility (%)</td><td style="text-align:right;" id="risk_annual_vol">Loading...</td></tr>
                                <tr><td>Maximum Drawdown (%)</td><td style="text-align:right;" id="risk_max_drawdown">Loading...</td></tr>
                                <tr><td>Value at Risk (VaR 95%)</td><td style="text-align:right;" id="risk_var95">Loading...</td></tr>
                            </tbody>
                        </table>
                        <h3 class="subtle" style="margin-top:12px;">Risk-Adjusted Performance</h3>
                        <table class="compact-table metrics-table">
                            <tbody>
                                <tr><td>Sharpe Ratio</td><td style="text-align:right;" id="ra_sharpe">Loading...</td></tr>
                                <tr><td>Sortino Ratio</td><td style="text-align:right;" id="ra_sortino">Loading...</td></tr>
                                <tr><td>Calmar Ratio</td><td style="text-align:right;" id="ra_calmar">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="width:360px;min-width:260px;">
                        <div class="chart-card">
                            <h3 class="subtle">Portfolio Composition</h3>
                            <div id="portfolioCompositionStackedBarChart" style="height:110px;">Loading composition...</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Daily returns chart -->
        <div class="stage-block">
            <h2 class="accent">Daily Returns</h2>
            <div class="chart-container">
                <div id="analysis-dailyreturns-chart" class="chart-inner"></div>
            </div>
        </div>

        <div id="runid-footnote" class="hidden"></div>

        <!-- Factor & Style Diagnostics -->
        <div class="stage-block">
            <h2 class="accent">Factor & Style Diagnostics</h2>
            <div class="stage-block muted">
                <h3 class="subtle">Sector Exposure</h3>
                <div class="chart-container">
                    <div id="sectorExposureChart" class="chart-inner">Loading...</div>
                </div>
            </div>

            <div class="stage-block muted">
                <h3 class="subtle">Concentration Risk</h3>
                <div class="stage-columns">
                    <div class="table-container column">
                        <table id="concentrationRiskTable" class="compact-table">
                            <thead>
                                <tr><th>Metric</th><th>Value</th></tr>
                            </thead>
                            <tbody>
                                <tr class="table-helper-row"><td colspan="2">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="table-container column">
                        <h3 class="subtle">Top 5 Holdings</h3>
                        <table id="top5HoldingsTable" class="compact-table">
                            <thead>
                                <tr><th>Stock</th><th>Weight (%)</th></tr>
                            </thead>
                            <tbody>
                                <tr class="table-helper-row"><td colspan="2">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="stage-block muted">
                <h3 class="subtle">Factor Tilts</h3>
                <div class="table-container">
                    <table id="factorTiltsTable" class="compact-table">
                        <thead>
                            <tr><th>Factor</th><th>Portfolio</th><th>Benchmark</th><th>Tilt</th><th>Interpretation</th></tr>
                        </thead>
                        <tbody>
                            <tr class="table-helper-row"><td colspan="5">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Momentum & Valuation Metrics -->
        <div class="stage-block">
            <h2 class="accent">Momentum & Valuation Metrics</h2>
            <p class="subtle">Portfolio-weighted aggregates of momentum signal and valuation metrics</p>
            <div class="stage-columns">
                <div class="table-container column">
                    <table id="momentumValuationTable" class="compact-table">
                        <thead>
                            <tr><th>Metric</th><th>Portfolio</th><th>Benchmark</th><th>Difference</th></tr>
                        </thead>
                        <tbody>
                            <tr class="table-helper-row"><td colspan="4">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="chart-container column">
                    <div id="momentumValuationChart" class="chart-inner">Loading...</div>
                </div>
            </div>

            <div class="stage-block muted mt-8">
                <h3 class="subtle">Metric Definitions</h3>
                <table class="compact-table">
                    <thead>
                        <tr><th>Metric</th><th>Description</th><th>Interpretation</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Momentum Signal</strong></td>
                            <td>Portfolio-weighted average momentum score (combines 3m/6m/12m price momentum)</td>
                            <td>Higher = stronger positive momentum; Lower = weaker or negative momentum</td>
                        </tr>
                        <tr>
                            <td><strong>Forward P/E</strong></td>
                            <td>Portfolio-weighted average forward price-to-earnings ratio</td>
                            <td>Lower = potentially undervalued (value tilt); Higher = growth expectations</td>
                        </tr>
                        <tr>
                            <td><strong>Dividend Yield (%)</strong></td>
                            <td>Portfolio-weighted average dividend yield</td>
                            <td>Higher = more income-focused; complements P/E for total valuation picture</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Performance Attribution -->
        <div class="stage-block">
            <h2 class="accent">Performance Attribution</h2>
            <p class="subtle">Brinson-Fachler attribution analysis comparing portfolio performance vs benchmark (last 12 months)</p>
            <div class="stage-block muted">
                <h3 class="subtle">Attribution Effects</h3>
                <div class="stage-columns">
                    <div class="chart-container column">
                        <div id="attributionChart" class="chart-inner">Loading...</div>
                    </div>
                    <div class="table-container column">
                        <table id="attributionTable" class="compact-table">
                            <thead>
                                <tr><th>Effect</th><th>Value (%)</th><th>Interpretation</th></tr>
                            </thead>
                            <tbody>
                                <tr class="table-helper-row"><td colspan="3">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="stage-block muted">
                <h3 class="subtle">Understanding Attribution</h3>
                <table class="compact-table">
                    <thead>
                        <tr><th>Component</th><th>What it Measures</th><th>Formula</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Stock Selection Effect</strong></td>
                            <td>Value added by choosing stocks that outperformed their sector</td>
                            <td>Σ w<sub>b</sub> × (r<sub>p</sub> - r<sub>b</sub>)</td>
                        </tr>
                        <tr>
                            <td><strong>Allocation Effect</strong></td>
                            <td>Value added by overweighting sectors that outperformed</td>
                            <td>Σ (w<sub>p</sub> - w<sub>b</sub>) × (r<sub>b</sub> - R<sub>b</sub>)</td>
                        </tr>
                        <tr>
                            <td><strong>Interaction Effect</strong></td>
                            <td>Combined impact of allocation and selection decisions</td>
                            <td>Σ (w<sub>p</sub> - w<sub>b</sub>) × (r<sub>p</sub> - r<sub>b</sub>)</td>
                        </tr>
                        <tr class="divider-top">
                            <td><strong>Total Active Return</strong></td>
                            <td>Sum of all attribution effects</td>
                            <td>Selection + Allocation + Interaction</td>
                        </tr>
                    </tbody>
                </table>
                <p class="subtle legend">
                    <strong>Legend:</strong> w<sub>p</sub> = portfolio weight, w<sub>b</sub> = benchmark weight,
                    r<sub>p</sub> = portfolio sector return, r<sub>b</sub> = benchmark sector return,
                    R<sub>b</sub> = benchmark total return
                </p>
            </div>
        </div>

        <!-- Practical Diagnostics -->
        <section id="practical-diagnostics" class="metrics-section stage-block">
          <h2 class="accent">Practical Diagnostics</h2>
          <div class="metric-card"><span>Turnover:</span> <span id="turnover"></span></div>
          <div class="metric-card"><span>Liquidity Screen:</span> <span id="liquidity"></span></div>
          <div class="metric-card"><span>Tracking Error vs Benchmark:</span> <span id="tracking-error"></span></div>
          <div class="metric-card"><span>Information Ratio:</span> <span id="info-ratio"></span></div>
        </section>

        <!-- Portfolio Diagnostics -->
        <div class="stage-block">
            <h2 class="accent">Portfolio Diagnostics</h2>
            <div class="table-container column narrow">
                <table id="portfolioDiagnosticsTable" class="compact-table">
                    <thead>
                        <tr><th>Metric</th><th>Value</th></tr>
                    </thead>
                    <tbody>
                        <tr class="table-helper-row"><td colspan="2">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- External scripts -->
    <script src="js/common_utils.js"></script>
    <script src="js/common_nav.js"></script>
    <script src="js/portfolio.js"></script>

    <script>
        // --- Stock Color Utility ---
        function getStockColorClass(ticker) {
            const hash = Array.from(String(ticker)).reduce((acc, c) => acc + c.charCodeAt(0), 0);
            return 'stock-color-' + ((hash % 10) + 1);
        }
        document.querySelectorAll('.stock-ticker').forEach(el => {
            if (el && el.textContent) el.classList.add(getStockColorClass(el.textContent.trim()));
        });
    </script>

    <script>
    // --- Practical Diagnostics Loader ---
    (function(){
      fetch('data/portfolio_diagnostics.json')
        .then(response => response.json())
        .then(data => {
          // Populate practical diagnostics elements
          document.getElementById('turnover').textContent = (data.turnover !== undefined && !isNaN(data.turnover)) ? Number(data.turnover).toFixed(4) : 'N/A';
          document.getElementById('liquidity').textContent = (data.liquidity_score !== undefined && !isNaN(data.liquidity_score)) ? Number(data.liquidity_score).toLocaleString(undefined, {maximumFractionDigits: 4}) : 'N/A';
          document.getElementById('tracking-error').textContent = (data.tracking_error !== undefined && !isNaN(data.tracking_error)) ? Number(data.tracking_error).toFixed(4) : 'N/A';
          document.getElementById('info-ratio').textContent = (data.information_ratio !== undefined && !isNaN(data.information_ratio)) ? Number(data.information_ratio).toFixed(4) : 'N/A';

          // Populate portfolioDiagnosticsTable with useful rows
          const metrics = [
            { key: 'momentum_signal_strength', label: 'Momentum Signal Strength' },
            { key: 'forward_pe_implied_upside', label: 'Forward P/E Implied Upside' },
            { key: 'weighted_dividend_yield', label: 'Weighted Dividend Yield' },
            { key: 'turnover', label: 'Turnover' },
            { key: 'liquidity_score', label: 'Liquidity Score' },
            { key: 'tracking_error', label: 'Tracking Error' },
            { key: 'information_ratio', label: 'Information Ratio' }
          ];
          const tbody = document.querySelector('#portfolioDiagnosticsTable tbody');
          if(tbody){
            tbody.innerHTML = '';
            metrics.forEach(m => {
              let val = data[m.key];
              if (val === null || val === undefined || isNaN(val)) val = 'N/A';
              else if (typeof val === 'number') val = val.toFixed(4);
              tbody.innerHTML += `<tr><td>${m.label}</td><td>${val}</td></tr>`;
            });
          }
        })
        .catch(() => {
          const elems = ['turnover','liquidity','tracking-error','info-ratio'];
          elems.forEach(id => { const el = document.getElementById(id); if(el) el.textContent = 'N/A'; });
          const tbody = document.querySelector('#portfolioDiagnosticsTable tbody');
          if(tbody) tbody.innerHTML = '<tr class="table-helper-row"><td colspan="2">No diagnostics available</td></tr>';
        });
    })();
    </script>

    <script>
    // --- Portfolio Composition renderer (safe, Plotly-aware) ---
    (function renderPortfolioComposition(){
        const el = document.getElementById('portfolioCompositionStackedBarChart');
        if(!el) return;
        el.innerHTML = 'Loading composition (latest run)...';
        const runSummaryPath = (typeof LATEST_RUN_SUMMARY_JSON_PATH !== 'undefined') ? LATEST_RUN_SUMMARY_JSON_PATH.split('?')[0] : 'data/latest_run_summary.json';
        fetch(runSummaryPath + '?t=' + new Date().getTime())
        .then(resp => { if(!resp.ok) throw new Error('latest run summary not found'); return resp.json(); })
        .then(json => {
            const details = json.best_portfolio_details || json;
            if(!details) { el.innerHTML = 'No composition details found.'; return; }
            let stocks = details.stocks || details.tickers || details.assets || [];
            if(typeof stocks === 'string') stocks = stocks.replace(/"/g,'').split(',').map(s => s.trim()).filter(Boolean);
            if(!Array.isArray(stocks)) stocks = [];
            let weights = details.weights || details.weights_pct || details.portfolio_weights || details.weights_pct || [];
            if(typeof weights === 'string') weights = weights.replace(/"/g,'').split(',').map(s => s.trim());
            if(!Array.isArray(weights)) weights = [];
            weights = weights.map(Number);
            if(stocks.length !== weights.length){
                // attempt to map if single weight
                if(weights.length === 0 && typeof details.weight === 'number') weights = [details.weight];
            }
            if(stocks.length === 0){ el.innerHTML = 'No stock-level composition found in latest run.'; return; }
            if(weights.length !== stocks.length){ el.innerHTML = 'Composition available but stocks/weights mismatch.'; return; }
            const sum = weights.reduce((a,b)=>a+(Number(b)||0),0);
            const norm = (sum>0)?weights.map(w=>Number(w)/sum):weights.map(_=>0);
            // If Plotly available, render stacked bar; otherwise render simple legend
            if(window.Plotly && typeof Plotly.newPlot === 'function'){
                const traces = stocks.map((ticker,i)=>({
                    x: [+(norm[i]*100).toFixed(4)],
                    y: ['Portfolio'],
                    name: ticker,
                    orientation: 'h',
                    type: 'bar',
                    marker: { color: (typeof getColorForTicker === 'function') ? getColorForTicker(ticker) : undefined },
                    text: [(norm[i]*100).toFixed(2) + '%'],
                    textposition: 'inside',
                    hovertemplate: ticker + ': %{x:.2f}%<extra></extra>'
                }));
                const layout = { barmode: 'stack', margin: {l: Math.max(100, Math.min(360, 12 + Math.max(...stocks.map(s=>s.length))*6)), r:20, t:12, b:18}, xaxis:{ticksuffix:'%', range:[0,100]}, yaxis:{automargin:true}, height:110 };
                try{ el.innerHTML=''; Plotly.newPlot(el, traces, layout, {responsive:true, displayModeBar:false}); }
                catch(e){ el.innerHTML = 'Could not render composition chart.'; console.warn(e); }
            } else {
                // Fallback: build a simple inline legend with colored pills and percentages
                el.innerHTML = '';
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.flexWrap = 'wrap';
                container.style.gap = '6px';
                stocks.forEach((t,i)=>{
                    const pill = document.createElement('div');
                    pill.style.padding = '6px 8px';
                    pill.style.borderRadius = '6px';
                    pill.style.background = '#f2f6fb';
                    pill.style.fontSize = '12px';
                    pill.textContent = `${t}: ${(norm[i]*100).toFixed(2)}%`;
                    container.appendChild(pill);
                });
                el.appendChild(container);
            }
        })
        .catch(err => { console.warn('Could not load latest run summary for composition:', err); el.innerHTML = 'No latest composition available.'; });
    })();
    </script>

</body>
</html>